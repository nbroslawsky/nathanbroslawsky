// Simple backup example in node.js
// 
// How to use:
// npm install storyblok-js-client
// 
// Create the folder 'backup'
// 
// Create the file 'backup.js' and execute
// node ./backup.js


process.env.NODE_TLS_REJECT_UNAUTHORIZED = '0'
let StoryblokClient = require('./dist/index.js')
const fs = require('fs')

let client = new StoryblokClient({
  accessToken: 'FtyUE8zLpZox3ptNYz3dgQtt'
}, 'https://localhost:3002/v1')

let lastPage = 1
let getStories = (page) => {
  client.get('cdn/stories', {
      version: 'draft',
      per_page: 2,
      page: page,
      rateLimit: 100
    }).then((res) => {

    let stories = res.data.stories
    stories.forEach((story) => {
      fs.writeFile('./coverage/' + story.full_slug.replace(new RegExp('/', 'g'), '_'), JSON.stringify(story), (err) => {  
        if (err) throw err

        console.log(story.full_slug + ' backed up')
      })
    })

    let total = res.total
    lastPage = Math.ceil((res.total / res.perPage))

    if (page <= lastPage) {
      page++
      getStories(page)
    }
  }).catch((test) => {
    console.log(test.response.status)
  })
}

getStories(1)

let client = new StoryblokClient({
  accessToken: 'FtyUE8zLpZox3ptNYz3dgQtt',
  componentResolver: (component, data) => {
    return component
  }
}, 'https://localhost:3002/v1')

client.get('cdn/stories/demo', {
  version: 'draft'
}).then((res) => {
  let story = res.data.story
  console.log(client.richTextResolver.render(story.content.mark))
})